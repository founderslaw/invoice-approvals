<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founders Law Invoice Approval System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            padding: 24px 32px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .header-left p {
            font-size: 14px;
            color: #6b7280;
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .filter-section {
            padding: 20px 32px;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-section label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .filter-section select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            color: #374151;
            background-color: white;
            cursor: pointer;
        }

        .share-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .share-link {
            padding: 6px 12px;
            background-color: #dbeafe;
            color: #1e40af;
            border-radius: 6px;
            font-size: 13px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .share-link:hover {
            background-color: #bfdbfe;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            text-align: left;
            padding: 12px 32px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f9fafb;
        }

        tbody tr.approved {
            background-color: #f0fdf4;
        }

        td {
            padding: 16px 32px;
            font-size: 14px;
        }

        .invoice-id {
            font-weight: 500;
            color: #111827;
        }

        .invoice-link {
            font-size: 12px;
            color: #3b82f6;
            text-decoration: none;
            margin-top: 2px;
            display: inline-block;
        }

        .invoice-link:hover {
            text-decoration: underline;
        }

        .client-name {
            font-weight: 500;
            color: #111827;
            margin-bottom: 2px;
        }

        .client-detail {
            font-size: 13px;
            color: #6b7280;
        }

        .lead-name {
            color: #111827;
        }

        .balance {
            font-weight: 600;
            color: #111827;
            text-align: right;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background-color: #d1fae5;
            color: #065f46;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .stats {
            padding: 20px 32px;
            background-color: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #6b7280;
        }

        .stats-item {
            display: flex;
            gap: 20px;
        }

        .stats-item span {
            font-weight: 600;
            color: #111827;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-btn:hover {
            background-color: #f3f4f6;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            color: #374151;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 24px;
            border-top: 1px solid #e5e7eb;
        }

        .admin-notice {
            background-color: #fef3c7;
            color: #92400e;
            padding: 12px 32px;
            font-size: 13px;
            border-bottom: 1px solid #fde68a;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background-color: #fee2e2;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #374151;
        }

        .share-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .share-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .share-card-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .share-card-stats {
            font-size: 13px;
            color: #6b7280;
        }

        .share-card-email {
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            margin-bottom: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .copy-email-btn {
            padding: 6px 12px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .copy-email-btn:hover {
            background-color: #059669;
        }

        .copy-email-btn.copied {
            background-color: #6b7280;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .status-loading {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .status-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .notes-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .notes-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .notes-btn-has-notes {
            background: #fef3c7;
            border-color: #fbbf24;
            color: #92400e;
            font-weight: 600;
        }

        .notes-btn-has-notes:hover {
            background: #fde68a;
        }

        .notes-btn-actioned {
            background: #d1fae5;
            border-color: #34d399;
            color: #065f46;
            font-weight: 600;
        }

        .notes-btn-actioned:hover {
            background: #a7f3d0;
        }

        .notes-badge {
            background: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 0 6px;
            font-size: 10px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        .notes-badge-actioned {
            background: #10b981;
            color: white;
            border-radius: 10px;
            padding: 0 6px;
            font-size: 10px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        .notes-display {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            color: #92400e;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }

        .notes-display strong {
            display: block;
            margin-bottom: 4px;
            color: #78350f;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Founders Law Invoice Approval System</h1>
                <p id="headerSubtitle">Review and approve outstanding invoices</p>
            </div>
            <div class="header-right">
                <button class="btn btn-secondary" onclick="toggleAdminMode()" id="adminToggle">
                    Admin Mode
                </button>
            </div>
        </div>

        <div id="adminNotice" class="admin-notice" style="display: none;">
            üîß Admin Mode Active - You can add, edit, and delete invoices
        </div>

        <div id="bulkAssignSection" class="admin-notice" style="display: none; background-color: #dbeafe; border-color: #93c5fd; color: #1e40af;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span id="unassignedLeadNotice">
                        üìã <strong id="unassignedCount">0</strong> invoices need account leads assigned
                    </span>
                    <span id="missingLinkNotice" style="margin-left: 20px; display: none;">
                        | üîó <strong id="missingLinkCount">0</strong> invoices missing links
                    </span>
                </div>
                <button class="btn btn-primary" onclick="showBulkAssignModal()" id="bulkAssignBtn" style="display: none;">
                    Quick Assign Leads
                </button>
            </div>
        </div>

        <div id="readOnlyBanner" style="display: none; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px 16px; margin-bottom: 16px; font-size: 13px; color: #475569; text-align: center;">
            üëÅÔ∏è <strong>View Only</strong> ‚Äî You are viewing a summary of all invoices. Open your personalised link to approve your invoices.
        </div>

        <div class="filter-section">
            <label for="leadFilter">Filter by Lead:</label>
            <select id="leadFilter" onchange="filterByLead(this.value)">
                <option value="">All Leads</option>
            </select>

            <button class="btn btn-secondary" onclick="toggleNotesFilter()" id="notesFilterBtn" title="Show only invoices with feedback">
                üí¨ <span id="notesFilterText">Show With Notes</span>
            </button>

            <div class="share-links" id="shareLinksContainer" style="display: none;">
                <span style="font-size: 13px; color: #6b7280;">Share:</span>
            </div>

            <button class="btn btn-primary" onclick="showShareAllModal()" id="shareAllBtn" style="display: none; margin-left: auto;">
                üìß Share All Links
            </button>

            <button class="btn btn-secondary" onclick="openHarvestSettingsModal()" id="harvestSettingsBtn" style="display: none;">
                ‚öôÔ∏è Harvest API
            </button>

            <button class="btn btn-primary" onclick="syncFromHarvest()" id="syncHarvestBtn" style="display: none;">
                üîÑ Sync from Harvest
            </button>

            <button class="btn btn-primary" onclick="openAddInvoiceModal()" id="addInvoiceBtn" style="display: none;">
                + Add Invoice
            </button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Invoice ID</th>
                    <th>Client</th>
                    <th>Account Lead</th>
                    <th style="text-align: right;">Balance</th>
                    <th>Status</th>
                    <th>Notes/Feedback</th>
                    <th>Approve</th>
                    <th id="adminActionsHeader" style="display: none;">Actions</th>
                </tr>
            </thead>
            <tbody id="invoiceTableBody">
                <!-- Invoices will be populated here -->
            </tbody>
        </table>

        <div class="stats">
            <div class="stats-item">
                <div>Total Invoices: <span id="totalCount">0</span></div>
                <div>Approved: <span id="approvedCount">0</span></div>
                <div>Pending: <span id="pendingCount">0</span></div>
            </div>
            <div>
                Total Balance: <span id="totalBalance">¬£0.00</span>
            </div>
        </div>
    </div>

    <!-- Add/Edit Invoice Modal -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Invoice</h2>
                <button class="close-btn" onclick="closeInvoiceModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="invoiceLink">Harvest Invoice URL</label>
                    <input type="url" id="invoiceLink" placeholder="https://founderslaw.harvestapp.com/invoices/..." style="width: 100%; margin-bottom: 8px;">
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="btn btn-primary" onclick="requestClaudeExtraction()" style="flex: 1;">
                            ü§ñ Extract with Claude
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="loadClaudeData()" style="flex: 1;">
                            üìã Load Extracted Data
                        </button>
                    </div>
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                        1Ô∏è‚É£ Paste URL ‚Üí 2Ô∏è‚É£ Click "Extract with Claude" ‚Üí 3Ô∏è‚É£ Paste URL in Claude chat ‚Üí 4Ô∏è‚É£ Copy returned data ‚Üí 5Ô∏è‚É£ Click "Load Extracted Data"
                    </small>
                </div>

                <div id="extractionStatus"></div>

                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <div class="form-group">
                        <label for="invoiceId">Invoice ID *</label>
                        <input type="text" id="invoiceId" required placeholder="e.g., TK001 (Jan 26)">
                    </div>
                    <div class="form-group">
                        <label for="clientName">Client Name *</label>
                        <input type="text" id="clientName" required placeholder="e.g., Test Kolleno 2">
                    </div>
                    <div class="form-group">
                        <label for="clientDetail">Client Detail</label>
                        <input type="text" id="clientDetail" placeholder="e.g., Founders Law">
                    </div>
                    <div class="form-group">
                        <label for="leadName">Account Lead *</label>
                        <select id="leadDropdown" onchange="handleLeadSelection(this.value)" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; color: #374151; margin-bottom: 8px;">
                            <option value="">-- Select existing lead or type new below --</option>
                        </select>
                        <input type="text" id="leadName" required placeholder="e.g., Sarah Johnson or select from dropdown above" list="leadSuggestions">
                        <datalist id="leadSuggestions"></datalist>
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Select from dropdown or type a new lead name
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="leadEmail">Account Lead Email</label>
                        <input type="email" id="leadEmail" placeholder="e.g., sarah.johnson@founderslaw.com">
                        <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                            Required for email reminders via Share All Links
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="balance">Balance (¬£) *</label>
                        <input type="number" id="balance" required step="0.01" placeholder="0.00">
                    </div>
                </form>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('invoiceForm').requestSubmit()">Save Invoice</button>
            </div>
        </div>
    </div>

    <!-- Share All Links Modal -->
    <div class="modal" id="shareAllModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìß Share Links with Account Leads</h2>
                <button class="close-btn" onclick="closeShareAllModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                    Click "Send Email" to open your mail client with a pre-filled message for each lead, or copy the email text to send manually. Each link is pre-filtered to show only their invoices.
                </p>
                
                <div id="shareAllContent"></div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeShareAllModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Harvest API Settings Modal -->
    <div class="modal" id="harvestSettingsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Harvest API Settings</h2>
                <button class="close-btn" onclick="closeHarvestSettingsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                    Connect to your Harvest account to automatically sync <strong>draft invoices</strong> that need approval. <a href="https://id.getharvest.com/developers" target="_blank" style="color: #3b82f6;">Get your API credentials here</a>.
                </p>

                <div style="background-color: #dbeafe; border: 1px solid #93c5fd; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 13px; color: #1e40af;">
                    <strong>üìå How Sync Works:</strong><br>
                    ‚Ä¢ Updates existing draft invoices with latest data from Harvest<br>
                    ‚Ä¢ Imports new draft invoices that aren't in the system yet<br>
                    ‚Ä¢ Removes invoices that are no longer drafts (they've been sent)<br>
                    ‚Ä¢ Keeps your list clean and in sync with Harvest
                </div>
                
                <div class="form-group">
                    <label for="harvestAccountId">Harvest Account ID *</label>
                    <input type="text" id="harvestAccountId" placeholder="e.g., 123456" value="">
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                        Found in your Harvest account settings
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="harvestAccessToken">Personal Access Token *</label>
                    <input type="password" id="harvestAccessToken" placeholder="Enter your token" value="">
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                        Create a token in Harvest Developer Tools
                    </small>
                </div>

                <div class="form-group">
                    <label for="harvestInvoiceState">Import Invoices with State:</label>
                    <select id="harvestInvoiceState" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        <option value="draft" selected>Draft (recommended - invoices pending approval)</option>
                        <option value="open">Open (unpaid)</option>
                        <option value="paid">Paid</option>
                        <option value="">All (not recommended)</option>
                    </select>
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                        <strong>Important:</strong> Only draft invoices need approval. Leave as "Draft" to avoid importing all invoices.
                    </small>
                </div>

                <div class="form-group">
                    <label for="productionUrl">Production URL (for email links) *</label>
                    <input type="text" id="productionUrl" placeholder="e.g., https://founderslaw.github.io/invoice-approvals" value="">
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                        The URL where this app is hosted. This will be used in email links to leads.
                    </small>
                </div>

                <div class="form-group">
                    <label for="adminPasswordSetting">Admin Password</label>
                    <input type="password" id="adminPasswordSetting" placeholder="Set a password for Admin Mode access">
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                        If set, this password will be required to enter Admin Mode. Leave blank to allow unrestricted admin access.
                    </small>
                </div>

                <div id="harvestStatusMessage" style="margin-top: 16px;"></div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeHarvestSettingsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveHarvestSettings()">Save & Test Connection</button>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div class="modal" id="adminPasswordModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>üîí Admin Access</h2>
                <button class="close-btn" onclick="closePasswordModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="adminPasswordInput">Password</label>
                    <input 
                        type="password" 
                        id="adminPasswordInput" 
                        placeholder="Enter admin password"
                        onkeydown="if(event.key === 'Enter') submitAdminPassword()"
                        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
                    >
                    <div id="passwordError" style="display: none; color: #ef4444; font-size: 13px; margin-top: 6px;">
                        ‚ùå Incorrect password. Please try again.
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitAdminPassword()">Enter</button>
            </div>
        </div>
    </div>

    <!-- Notes/Feedback Modal -->
    <div class="modal" id="notesModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="notesModalTitle">üí¨ Add Feedback/Notes</h2>
                <button class="close-btn" onclick="closeNotesModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p id="notesModalInvoiceInfo" style="color: #6b7280; font-size: 14px; margin-bottom: 8px;"></p>
                
                <div id="notesActionedStatus" style="display: none; background: #d1fae5; border: 1px solid #34d399; border-radius: 6px; padding: 10px; margin-bottom: 16px; font-size: 13px; color: #065f46;">
                    ‚úÖ <strong>Note has been actioned by admin</strong>
                </div>
                
                <div class="form-group">
                    <label for="invoiceNotes">Feedback/Notes</label>
                    <textarea id="invoiceNotes" rows="5" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="E.g., Please update the project description to include Q1 deliverables..."></textarea>
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                        These notes will be visible to the admin and included in email reminders.
                    </small>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeNotesModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
                <button class="btn btn-secondary" id="toggleActionedBtn" onclick="toggleNoteActioned()" style="margin-left: auto; display: none;">Mark as Actioned</button>
                <button class="btn btn-secondary" onclick="clearNotes()" style="display: none;" id="clearNotesBtn">Clear Notes</button>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets Backend Configuration
        const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbyVi_GO4Gy46OgdKTE_3_VX5mr31GsxSYeksIBv8FoadP6TX6xU1rfTAKWf7mIk-Y9T/exec';
        
        let invoices = [];
        let adminMode = false;
        let editingIndex = null;
        let editingNotesInvoiceId = null; // Track which invoice we're editing notes for
        let showOnlyWithNotes = false; // Track notes filter state

        // Pre-defined account leads with emails
        const predefinedLeads = [
            { name: 'Lynda', email: 'Lynda@founders-law.co.uk' },
            { name: 'Abdul', email: 'Abdul@founders-law.co.uk' },
            { name: 'Al', email: 'Al@founders-law.co.uk' },
            { name: 'Amy', email: 'Amy@founders-law.co.uk' },
            { name: 'Anca', email: 'Anca@founders-law.co.uk' },
            { name: 'Benji', email: 'Benji@founders-law.co.uk' },
            { name: 'Cullen', email: 'Cullen@founders-law.co.uk' },
            { name: 'Dimi', email: 'Dimi@founders-law.co.uk' },
            { name: 'Jackie', email: 'Jackie@founders-law.co.uk' },
            { name: 'Rebecca', email: 'Rebecca@founders-law.co.uk' },
            { name: 'Tol', email: 'Tol@founders-law.co.uk' },
            { name: 'Tom', email: 'Tom@founders-law.co.uk' }
        ];

        // Get lead email from predefined list
        function getLeadEmail(leadName) {
            const lead = predefinedLeads.find(l => l.name === leadName);
            return lead ? lead.email : '';
        }

        // Initialize with sample data
        async function initializeSampleData() {
            try {
                // Load invoices from Google Sheets
                const loadedInvoices = await getSheetsData('getInvoices');
                
                if (loadedInvoices && loadedInvoices.length > 0) {
                    invoices = loadedInvoices;
                } else {
                    // No invoices yet - add sample data
                    invoices = [
                        {
                            id: 'TK001 (Jan 26)',
                            client: 'Test Kolleno 2',
                            clientDetail: 'Founders Law',
                            lead: 'Tom',
                            leadEmail: 'Tom@founders-law.co.uk',
                            balance: 1122.00,
                            link: 'https://founderslaw.harvestapp.com/invoices/sample001',
                            notes: '',
                            noteActioned: false
                        }
                    ];
                    await saveInvoices();
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
                // Fallback to empty array
                invoices = [];
            }
        }

        // Request Claude extraction
        function requestClaudeExtraction() {
            const url = document.getElementById('invoiceLink').value;
            const statusDiv = document.getElementById('extractionStatus');

            if (!url) {
                statusDiv.innerHTML = '<div class="status-message status-error">Please enter a Harvest invoice URL first</div>';
                return;
            }

            if (!url.includes('harvestapp.com/invoices/')) {
                statusDiv.innerHTML = '<div class="status-message status-error">Please enter a valid Harvest invoice URL</div>';
                return;
            }

            // Copy a formatted message to clipboard
            const message = `Extract invoice data from: ${url}`;
            navigator.clipboard.writeText(message).then(() => {
                statusDiv.innerHTML = `
                    <div class="status-message status-success">
                        ‚úÖ <strong>Ready for Claude extraction!</strong><br><br>
                        <strong>Next steps:</strong><br>
                        1. Open your chat with Claude (Claude in Chrome or claude.ai)<br>
                        2. Paste the copied message (already in your clipboard)<br>
                        3. Claude will extract: Invoice ID, Client Name, Balance<br>
                        4. Copy the JSON data Claude returns<br>
                        5. Come back here and click "Load Extracted Data"<br><br>
                        <em>Message copied to clipboard: "${message}"</em>
                    </div>
                `;
            }).catch(() => {
                statusDiv.innerHTML = `
                    <div class="status-message status-loading">
                        üìã <strong>Please copy this message and send to Claude:</strong><br><br>
                        <code style="background: #f3f4f6; padding: 8px; border-radius: 4px; display: block; margin-top: 8px;">
                        Extract invoice data from: ${url}
                        </code>
                    </div>
                `;
            });
        }

        // Load data extracted by Claude
        function loadClaudeData() {
            const statusDiv = document.getElementById('extractionStatus');
            
            navigator.clipboard.readText().then(text => {
                try {
                    // Try to parse as JSON
                    const data = JSON.parse(text);
                    
                    // Fill the form
                    if (data.invoiceId || data.invoiceNum) {
                        document.getElementById('invoiceId').value = data.invoiceId || data.invoiceNum || '';
                    }
                    if (data.client || data.clientName) {
                        document.getElementById('clientName').value = data.client || data.clientName || '';
                    }
                    if (data.balance) {
                        document.getElementById('balance').value = data.balance;
                    }
                    if (data.link || data.url) {
                        document.getElementById('invoiceLink').value = data.link || data.url || '';
                    }

                    statusDiv.innerHTML = `
                        <div class="status-message status-success">
                            ‚úÖ <strong>Data loaded successfully!</strong><br>
                            Invoice ID: ${data.invoiceId || data.invoiceNum || 'Not found'}<br>
                            Client: ${data.client || data.clientName || 'Not found'}<br>
                            Balance: ¬£${data.balance || 'Not found'}<br><br>
                            Please verify and add the Account Lead, then click Save!
                        </div>
                    `;
                } catch (e) {
                    // Not JSON, maybe it's formatted text
                    statusDiv.innerHTML = `
                        <div class="status-message status-error">
                            ‚ùå Could not parse clipboard data as JSON.<br><br>
                            <strong>Expected format from Claude:</strong><br>
                            <code style="background: #f3f4f6; padding: 8px; border-radius: 4px; display: block; margin-top: 8px;">
                            {<br>
                            &nbsp;&nbsp;"invoiceId": "HL001 (Jan 26)",<br>
                            &nbsp;&nbsp;"client": "Hanei Limited",<br>
                            &nbsp;&nbsp;"balance": "5348.40",<br>
                            &nbsp;&nbsp;"link": "https://..."<br>
                            }
                            </code><br>
                            Please make sure you copied the JSON data from Claude.
                        </div>
                    `;
                }
            }).catch(err => {
                statusDiv.innerHTML = `
                    <div class="status-message status-error">
                        ‚ùå Could not read clipboard. Please make sure you:<br>
                        1. Copied the JSON data from Claude<br>
                        2. Granted clipboard permissions to this page<br><br>
                        Error: ${err.message}
                    </div>
                `;
            });
        }

        // Fetch data from Harvest URL using browser automation
        async function fetchFromHarvestURL() {
            const url = document.getElementById('invoiceLink').value;
            const statusDiv = document.getElementById('extractionStatus');

            if (!url) {
                statusDiv.innerHTML = '<div class="status-message status-error">Please enter a Harvest invoice URL first</div>';
                return;
            }

            if (!url.includes('harvestapp.com/invoices/')) {
                statusDiv.innerHTML = '<div class="status-message status-error">Please enter a valid Harvest invoice URL</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status-message status-loading">üîÑ Fetching invoice data from Harvest...</div>';

            try {
                // This will be handled by Claude in Chrome
                const message = {
                    action: 'fetchInvoice',
                    url: url
                };
                
                // Post message to parent window if in iframe, otherwise alert
                if (window.parent !== window) {
                    window.parent.postMessage(message, '*');
                } else {
                    alert('CLAUDE: Please use your browser automation tools to navigate to: ' + url + ' and extract the Client Name, Invoice Number, and Balance, then fill the form.');
                }

                statusDiv.innerHTML = '<div class="status-message status-loading">‚è≥ Waiting for Claude to extract data... (check your browser tabs)</div>';
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="status-message status-error">‚ùå Error: ' + error.message + '</div>';
            }
        }

        // Function to fill form with extracted data (called by Claude)
        function fillFormWithExtractedData(data) {
            const statusDiv = document.getElementById('extractionStatus');
            
            if (data.client) {
                document.getElementById('clientName').value = data.client;
            }
            if (data.invoiceNum) {
                document.getElementById('invoiceId').value = data.invoiceNum;
            }
            if (data.balance) {
                document.getElementById('balance').value = data.balance;
            }

            statusDiv.innerHTML = `<div class="status-message status-success">‚úÖ Data extracted successfully!<br>Client: ${data.client || 'Not found'}<br>Invoice: ${data.invoiceNum || 'Not found'}<br>Balance: ¬£${data.balance || 'Not found'}</div>`;
        }

        // Save invoices to Google Sheets
        // ===== GOOGLE SHEETS API FUNCTIONS =====
        
        // Call Google Sheets API
        async function callSheetsAPI(action, data = {}) {
            try {
                const payload = { action, ...data };
                const response = await fetch(GOOGLE_SHEETS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                // Note: no-cors means we can't read the response
                // For reads, we'll use GET with JSONP-style callback
                return { success: true };
            } catch (error) {
                console.error('Sheets API error:', error);
                throw error;
            }
        }
        
        // Get data from Google Sheets (using GET for CORS)
        async function getSheetsData(action) {
            try {
                const response = await fetch(`${GOOGLE_SHEETS_API_URL}?action=${action}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Sheets API GET error:', error);
                throw error;
            }
        }
        
        // Save invoices to Google Sheets
        async function saveInvoices() {
            try {
                await callSheetsAPI('saveInvoices', { invoices });
                console.log('Invoices saved to Google Sheets');
            } catch (error) {
                console.error('Error saving invoices:', error);
                alert('Error saving invoices. Please try again.');
            }
        }

        // Load approval state from Google Sheets
        async function loadApprovalState() {
            try {
                const approvals = await getSheetsData('getApprovals');
                return approvals || {};
            } catch (error) {
                console.error('Error loading approvals:', error);
                return {};
            }
        }

        // Save individual approval to Google Sheets
        // Get current approver name based on context
        function getCurrentApprover() {
            const urlParams = new URLSearchParams(window.location.search);
            const leadParam = urlParams.get('lead');
            if (adminMode) return 'Admin';
            if (leadParam) return leadParam;
            return 'Unknown';
        }

        async function saveApproval(invoiceId, approved) {
            try {
                await callSheetsAPI('saveApproval', { 
                    invoiceId, 
                    approved,
                    approvedBy: approved ? getCurrentApprover() : '' // Clear approver if unapproving
                });
                console.log(`Approval saved for ${invoiceId}: ${approved}`);
            } catch (error) {
                console.error('Error saving approval:', error);
            }
        }

        // Load Harvest settings from Google Sheets
        async function loadHarvestSettings() {
            try {
                const settings = await getSheetsData('getSettings');
                return {
                    accountId: settings.harvestAccountId || '',
                    accessToken: settings.harvestAccessToken || '',
                    invoiceState: settings.harvestInvoiceState || 'draft',
                    productionUrl: settings.productionUrl || '',
                    adminPassword: settings.adminPassword || ''
                };
            } catch (error) {
                console.error('Error loading Harvest settings:', error);
                return {
                    accountId: '',
                    accessToken: '',
                    invoiceState: 'draft',
                    productionUrl: '',
                    adminPassword: ''
                };
            }
        }

        // Save Harvest setting to Google Sheets
        async function saveHarvestSetting(key, value) {
            try {
                await callSheetsAPI('saveSetting', { key, value });
            } catch (error) {
                console.error('Error saving setting:', error);
            }
        }

        // Get production URL for email links
        async function getProductionUrl() {
            const settings = await loadHarvestSettings();
            if (settings.productionUrl && settings.productionUrl.trim() !== '') {
                return settings.productionUrl.trim();
            }
            // Fallback to current URL (for local testing)
            return window.location.origin + window.location.pathname;
        }

        // ===== DATA IMPORT HELPER =====
        // Import existing invoice data
        async function importInvoiceData(invoiceData) {
            try {
                console.log('Importing', invoiceData.length, 'invoices...');
                invoices = invoiceData;
                await saveInvoices();
                updateLeadFilter();
                await renderInvoices();
                console.log('‚úÖ Import complete!');
                alert(`‚úÖ Successfully imported ${invoiceData.length} invoices!`);
            } catch (error) {
                console.error('Import error:', error);
                alert('‚ùå Error importing data. Check console for details.');
            }
        }

        // Format currency
        function formatCurrency(amount) {
            return '¬£' + amount.toLocaleString('en-GB', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Get unique leads
        function getUniqueLeads() {
            return [...new Set(invoices.map(inv => inv.lead))].sort();
        }

        // Update lead filter dropdown
        function updateLeadFilter() {
            const select = document.getElementById('leadFilter');
            const currentValue = select.value;
            const leads = getUniqueLeads();
            
            select.innerHTML = '<option value="">All Leads</option>';
            leads.forEach(lead => {
                const option = document.createElement('option');
                option.value = lead;
                option.textContent = lead;
                select.appendChild(option);
            });
            
            const urlParams = new URLSearchParams(window.location.search);
            const leadParam = urlParams.get('lead');
            if (leadParam) {
                select.value = leadParam;
            } else if (currentValue) {
                select.value = currentValue;
            }
        }

        // Update share links
        function updateShareLinks() {
            const container = document.getElementById('shareLinksContainer');
            const shareAllBtn = document.getElementById('shareAllBtn');
            const leads = getUniqueLeads();
            
            if (adminMode && leads.length > 0) {
                container.style.display = 'flex';
                shareAllBtn.style.display = 'block';
                const baseUrl = window.location.origin + window.location.pathname;
                
                while (container.children.length > 1) {
                    container.removeChild(container.lastChild);
                }
                
                leads.forEach(lead => {
                    const link = document.createElement('a');
                    link.href = `${baseUrl}?lead=${encodeURIComponent(lead)}`;
                    link.className = 'share-link';
                    link.textContent = lead;
                    link.onclick = (e) => {
                        e.preventDefault();
                        navigator.clipboard.writeText(link.href);
                        link.textContent = '‚úì Copied!';
                        setTimeout(() => link.textContent = lead, 2000);
                    };
                    container.appendChild(link);
                });
            } else {
                container.style.display = 'none';
                shareAllBtn.style.display = 'none';
            }
        }

        // Show Share All Links modal
        async function showShareAllModal() {
            const leads = getUniqueLeads();
            const baseUrl = await getProductionUrl();
            const content = document.getElementById('shareAllContent');
            
            let html = '';
            
            leads.forEach(lead => {
                const leadInvoices = invoices.filter(inv => inv.lead === lead);
                const totalBalance = leadInvoices.reduce((sum, inv) => sum + inv.balance, 0);
                const link = `${baseUrl}?lead=${encodeURIComponent(lead)}`;
                
                // Get lead email (from invoice or predefined leads)
                let leadEmail = leadInvoices.find(inv => inv.leadEmail)?.leadEmail || '';
                
                // Fall back to predefined leads if no email set on invoices
                if (!leadEmail) {
                    leadEmail = getLeadEmail(lead);
                }
                
                // Build invoice list with notes
                let invoiceList = '';
                leadInvoices.forEach(inv => {
                    invoiceList += `\n‚Ä¢ ${inv.id}: ${inv.client} - ${formatCurrency(inv.balance)}`;
                    if (inv.notes && inv.notes.trim() !== '') {
                        invoiceList += `\n  üìù Note: ${inv.notes}`;
                    }
                });
                
                const emailBody = `Hi ${lead.split(' ')[0]},

You have ${leadInvoices.length} invoice${leadInvoices.length > 1 ? 's' : ''} ready for your approval (Total: ${formatCurrency(totalBalance)}).

Please review and approve them at your earliest convenience:
${link}

Invoices pending your approval:${invoiceList}

Instructions:
1. Click the link above
2. Review each invoice
3. If you need changes, click "üí¨ Add Note" to leave feedback
4. Check the "Approve" box for invoices you approve
5. Your approvals are saved automatically

If you have any questions, please let me know.

Best regards,
Founders Law`;

                html += `
                    <div class="share-card">
                        <div class="share-card-header">
                            <h3>${lead}${leadEmail ? ` <span style="font-size: 13px; color: #6b7280; font-weight: normal;">(${leadEmail})</span>` : ''}</h3>
                            <span class="share-card-stats">${leadInvoices.length} invoice${leadInvoices.length > 1 ? 's' : ''} ‚Ä¢ ${formatCurrency(totalBalance)}</span>
                        </div>
                        ${!leadEmail ? '<div style="background-color: #fef3c7; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 12px; color: #92400e;">‚ö†Ô∏è No email address - Click Edit on their invoices to add one</div>' : ''}
                        <div class="share-card-email">${emailBody}</div>
                        <div style="display: flex; gap: 8px;">
                            ${leadEmail ? `
                                <button class="btn btn-primary" onclick="sendEmailToLead('${lead.replace(/'/g, "\\'")}', '${leadEmail.replace(/'/g, "\\'")}', ${leadInvoices.length}, ${totalBalance})" style="flex: 1;">
                                    üìß Send Email (Opens Mail Client)
                                </button>
                            ` : ''}
                            <button class="copy-email-btn" onclick="copyEmailText(this, '${lead.replace(/'/g, "\\'")}');" style="${leadEmail ? 'flex: 1;' : 'width: 100%;'}">
                                üìã Copy Email Text
                            </button>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
            document.getElementById('shareAllModal').classList.add('active');
        }

        // Send email to lead via mailto
        async function sendEmailToLead(leadName, leadEmail, invoiceCount, totalBalance) {
            const baseUrl = await getProductionUrl();
            const link = `${baseUrl}?lead=${encodeURIComponent(leadName)}`;
            
            // Get invoices for this lead to include notes
            const leadInvoices = invoices.filter(inv => inv.lead === leadName);
            
            // Build invoice list with notes
            let invoiceList = '';
            leadInvoices.forEach(inv => {
                invoiceList += `\n‚Ä¢ ${inv.id}: ${inv.client} - ${formatCurrency(inv.balance)}`;
                if (inv.notes && inv.notes.trim() !== '') {
                    invoiceList += `\n  üìù Note: ${inv.notes}`;
                }
            });
            
            const subject = `Invoice Approval Request - ${invoiceCount} Invoice${invoiceCount > 1 ? 's' : ''} (${formatCurrency(totalBalance)})`;
            
            const emailBody = `Hi ${leadName.split(' ')[0]},

You have ${invoiceCount} invoice${invoiceCount > 1 ? 's' : ''} ready for your approval (Total: ${formatCurrency(totalBalance)}).

Please review and approve them at your earliest convenience:
${link}

Invoices pending your approval:${invoiceList}

Instructions:
1. Click the link above
2. Review each invoice
3. If you need changes, click "üí¨ Add Note" to leave feedback
4. Check the "Approve" box for invoices you approve
5. Your approvals are saved automatically

If you have any questions, please let me know.

Best regards,
Founders Law`;

            // Create mailto link
            const mailtoLink = `mailto:${leadEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            console.log('Attempting to open mailto link for:', leadEmail);
            console.log('mailto link length:', mailtoLink.length);
            
            // Create a temporary link and click it (works best on Mac)
            const link_element = document.createElement('a');
            link_element.href = mailtoLink;
            link_element.target = '_blank';
            link_element.style.display = 'none';
            document.body.appendChild(link_element);
            
            try {
                link_element.click();
                console.log('Mailto link clicked successfully');
                
                // Show success message
                setTimeout(() => {
                    alert('Opening Outlook... If Outlook doesn\'t open, please check:\n\n1. Outlook is your default email client\n2. System Preferences > General > Default email reader is set to Outlook\n3. Or use the "Copy Email Text" button instead');
                }, 100);
            } catch (e) {
                console.error('Error opening mailto:', e);
                alert('Could not open Outlook automatically. Please use the "Copy Email Text" button instead.');
            } finally {
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link_element);
                }, 1000);
            }
        }

        // Close Share All modal
        function closeShareAllModal() {
            document.getElementById('shareAllModal').classList.remove('active');
        }

        // Copy email text
        function copyEmailText(button, leadName) {
            const emailDiv = button.previousElementSibling;
            const text = emailDiv.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                button.textContent = '‚úì Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'üìã Copy Email';
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        // Filter by lead
        function filterByLead(lead) {
            const urlParams = new URLSearchParams(window.location.search);
            if (lead) {
                urlParams.set('lead', lead);
                document.getElementById('headerSubtitle').textContent = `Invoices for ${lead}`;
            } else {
                urlParams.delete('lead');
                document.getElementById('headerSubtitle').textContent = 'Review and approve outstanding invoices';
            }
            
            const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.history.replaceState({}, '', newUrl);
            
            renderInvoices();
        }

        // Get filtered invoices
        function getFilteredInvoices() {
            const leadFilter = document.getElementById('leadFilter').value;
            let filtered = invoices;
            
            // Filter by lead
            if (leadFilter) {
                filtered = filtered.filter(inv => inv.lead === leadFilter);
            }
            
            // Filter by notes
            if (showOnlyWithNotes) {
                filtered = filtered.filter(inv => inv.notes && inv.notes.trim() !== '');
            }
            
            // Sort alphabetically by client name
            filtered.sort((a, b) => {
                const clientA = (a.client || '').toLowerCase();
                const clientB = (b.client || '').toLowerCase();
                return clientA.localeCompare(clientB);
            });
            
            return filtered;
        }

        // Toggle notes filter
        function toggleNotesFilter() {
            showOnlyWithNotes = !showOnlyWithNotes;
            const btn = document.getElementById('notesFilterBtn');
            const text = document.getElementById('notesFilterText');
            
            if (showOnlyWithNotes) {
                btn.className = 'btn btn-primary';
                text.textContent = 'Show All';
            } else {
                btn.className = 'btn btn-secondary';
                text.textContent = 'Show With Notes';
            }
            
            renderInvoices();
        }

        // Update statistics
        async function updateStats() {
            const approvals = await loadApprovalState();
            const filteredInvoices = getFilteredInvoices();
            const approved = filteredInvoices.filter(inv => approvals[inv.id] && approvals[inv.id].approved).length;
            const total = filteredInvoices.length;
            const pending = total - approved;
            const totalBalance = filteredInvoices.reduce((sum, inv) => sum + inv.balance, 0);

            document.getElementById('totalCount').textContent = total;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
        }

        // Handle approval change
        async function handleApprovalChange(invoiceId, isChecked) {
            // Save to Google Sheets
            await saveApproval(invoiceId, isChecked);
            
            const row = document.querySelector(`tr[data-invoice-id="${invoiceId}"]`);
            if (isChecked) {
                row.classList.add('approved');
            } else {
                row.classList.remove('approved');
            }
            
            const statusCell = row.querySelector('.status-badge').parentElement;
            const statusBadge = row.querySelector('.status-badge');
            statusBadge.textContent = isChecked ? 'Approved' : 'Pending';
            statusBadge.className = isChecked ? 'status-badge status-approved' : 'status-badge status-pending';
            
            // Update approver name display
            let approverEl = statusCell.querySelector('.approver-name');
            if (isChecked) {
                const approver = getCurrentApprover();
                if (!approverEl) {
                    approverEl = document.createElement('div');
                    approverEl.className = 'approver-name';
                    approverEl.style.cssText = 'font-size: 11px; color: #6b7280; margin-top: 3px;';
                    statusCell.appendChild(approverEl);
                }
                approverEl.textContent = `by ${approver}`;
            } else if (approverEl) {
                approverEl.remove();
            }
            
            // Update label
            const label = row.querySelector(`label[for="approve-${invoiceId}"]`);
            if (label) label.textContent = isChecked ? 'Approved' : 'Approve';
            
            updateStats();
        }

        // Render invoices
        async function renderInvoices() {
            const approvals = await loadApprovalState();
            const tbody = document.getElementById('invoiceTableBody');
            const filteredInvoices = getFilteredInvoices();
            const urlParams = new URLSearchParams(window.location.search);
            const canApprove = adminMode || !!urlParams.get('lead');

            // Show/hide read-only banner
            document.getElementById('readOnlyBanner').style.display = canApprove ? 'none' : 'block';
            
            if (filteredInvoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="border: none;">
                            <div class="empty-state">
                                <h3>No invoices found</h3>
                                <p>${adminMode ? 'Click "Add Invoice" to get started' : 'No invoices to approve'}</p>
                            </div>
                        </td>
                    </tr>
                `;
                updateStats();
                return;
            }
            
            tbody.innerHTML = filteredInvoices.map((invoice, index) => {
                const approvalData = approvals[invoice.id] || { approved: false, approvedBy: '' };
                const isApproved = approvalData.approved || false;
                const approvedBy = approvalData.approvedBy || '';
                const globalIndex = invoices.findIndex(inv => inv.id === invoice.id);
                return `
                    <tr data-invoice-id="${invoice.id}" class="${isApproved ? 'approved' : ''}">
                        <td>
                            <div class="invoice-id">${invoice.id}</div>
                            ${invoice.link ? 
                                `<a href="${invoice.link}" target="_blank" class="invoice-link">View Invoice ‚Üí</a>` : 
                                (adminMode ? '<span style="color: #ef4444; font-size: 12px;">‚ö†Ô∏è No link - Click Edit to add</span>' : '')
                            }
                        </td>
                        <td>
                            <div class="client-name">${invoice.client}</div>
                            ${invoice.clientDetail ? `<div class="client-detail">${invoice.clientDetail}</div>` : ''}
                        </td>
                        <td>
                            <div class="lead-name">${invoice.lead}</div>
                        </td>
                        <td class="balance">
                            ${formatCurrency(invoice.balance)}
                        </td>
                        <td>
                            <span class="status-badge ${isApproved ? 'status-approved' : 'status-pending'}">
                                ${isApproved ? 'Approved' : 'Pending'}
                            </span>
                            ${isApproved && approvedBy ? `<div style="font-size: 11px; color: #6b7280; margin-top: 3px;">by ${approvedBy}</div>` : ''}
                        </td>
                        <td style="text-align: center;">
                            <button 
                                class="notes-btn ${invoice.notes && invoice.noteActioned ? 'notes-btn-actioned' : invoice.notes ? 'notes-btn-has-notes' : ''}" 
                                onclick="openNotesModal('${invoice.id}')"
                                title="${invoice.notes && invoice.noteActioned ? 'Note actioned - view details' : invoice.notes ? 'View/Edit feedback' : 'Add feedback'}"
                            >
                                ${invoice.notes && invoice.noteActioned ? '‚úÖ Actioned' : invoice.notes ? 'üí¨ Has Notes' : 'üí¨ Add Note'}
                                ${invoice.notes && !invoice.noteActioned ? '<span class="notes-badge">!</span>' : invoice.notes && invoice.noteActioned ? '<span class="notes-badge-actioned">‚úì</span>' : ''}
                            </button>
                        </td>
                        <td>
                            <div class="checkbox-container" title="${!canApprove ? 'Open your personalised link to approve' : ''}">
                                <input 
                                    type="checkbox" 
                                    id="approve-${invoice.id}" 
                                    ${isApproved ? 'checked' : ''}
                                    ${!canApprove ? 'disabled' : ''}
                                    onchange="handleApprovalChange('${invoice.id}', this.checked)"
                                    style="${!canApprove ? 'cursor: not-allowed; opacity: 0.4;' : ''}"
                                >
                                <label for="approve-${invoice.id}" style="cursor: ${canApprove ? 'pointer' : 'not-allowed'}; color: ${canApprove ? '#6b7280' : '#adb5bd'}; font-size: 13px;">
                                    ${isApproved ? 'Approved' : canApprove ? 'Approve' : 'View Only'}
                                </label>
                            </div>
                        </td>
                        <td style="display: ${adminMode ? 'table-cell' : 'none'};">
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <button class="btn btn-secondary" onclick="openEditInvoiceModal(${globalIndex})" title="Edit invoice" style="padding: 4px 12px; font-size: 12px;">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="delete-btn" onclick="deleteInvoice(${globalIndex})" title="Delete invoice">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateStats();
        }

        // Toggle admin mode
        function toggleAdminMode() {
            if (!adminMode) {
                // Enabling admin - check if password is set
                openPasswordModal();
            } else {
                // Disabling admin - no password needed
                activateAdminMode(false);
            }
        }

        function openPasswordModal() {
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('adminPasswordModal').classList.add('active');
            setTimeout(() => document.getElementById('adminPasswordInput').focus(), 100);
        }

        function closePasswordModal() {
            document.getElementById('adminPasswordModal').classList.remove('active');
        }

        async function submitAdminPassword() {
            const entered = document.getElementById('adminPasswordInput').value;
            const settings = await loadHarvestSettings();
            const correctPassword = settings.adminPassword || '';

            // If no password has been set, allow access
            if (!correctPassword || entered === correctPassword) {
                closePasswordModal();
                activateAdminMode(true);
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').focus();
            }
        }

        function activateAdminMode(enable) {
            adminMode = enable;
            const btn = document.getElementById('adminToggle');
            const addBtn = document.getElementById('addInvoiceBtn');
            const harvestSettingsBtn = document.getElementById('harvestSettingsBtn');
            const syncHarvestBtn = document.getElementById('syncHarvestBtn');
            const notice = document.getElementById('adminNotice');
            const bulkSection = document.getElementById('bulkAssignSection');
            const adminActionsHeader = document.getElementById('adminActionsHeader');
            
            if (adminMode) {
                btn.textContent = 'Exit Admin';
                btn.className = 'btn btn-primary';
                addBtn.style.display = 'block';
                harvestSettingsBtn.style.display = 'block';
                syncHarvestBtn.style.display = 'block';
                notice.style.display = 'block';
                bulkSection.style.display = 'block';
                adminActionsHeader.style.display = 'table-cell';
                updateUnassignedCount();
            } else {
                btn.textContent = 'Admin Mode';
                btn.className = 'btn btn-secondary';
                addBtn.style.display = 'none';
                harvestSettingsBtn.style.display = 'none';
                syncHarvestBtn.style.display = 'none';
                notice.style.display = 'none';
                bulkSection.style.display = 'none';
                adminActionsHeader.style.display = 'none';
            }
            
            updateShareLinks();
            renderInvoices();
        }

        // Update unassigned invoice count
        function updateUnassignedCount() {
            const unassigned = invoices.filter(inv => !inv.lead || inv.lead.trim() === '');
            const missingLinks = invoices.filter(inv => !inv.link || inv.link.trim() === '');
            
            const unassignedCount = unassigned.length;
            const missingLinkCount = missingLinks.length;
            
            document.getElementById('unassignedCount').textContent = unassignedCount;
            document.getElementById('bulkAssignBtn').style.display = unassignedCount > 0 ? 'block' : 'none';
            
            // Show/hide missing links notice
            const missingLinkNotice = document.getElementById('missingLinkNotice');
            if (missingLinkCount > 0) {
                missingLinkNotice.style.display = 'inline';
                document.getElementById('missingLinkCount').textContent = missingLinkCount;
            } else {
                missingLinkNotice.style.display = 'none';
            }
        }

        // Show bulk assign modal
        function showBulkAssignModal() {
            alert('Quick Assign feature coming soon! For now, use the ‚úèÔ∏è Edit button on each invoice to assign leads.');
        }

        // Open add invoice modal
        function openAddInvoiceModal() {
            editingIndex = null;
            document.getElementById('modalTitle').textContent = 'Add Invoice';
            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceLink').value = '';
            document.getElementById('extractionStatus').innerHTML = '';
            document.getElementById('invoiceModal').classList.add('active');
            updateLeadSuggestions();
            document.getElementById('leadDropdown').value = '';
        }

        // Open edit invoice modal
        function openEditInvoiceModal(index) {
            editingIndex = index;
            const invoice = invoices[index];
            
            document.getElementById('modalTitle').textContent = 'Edit Invoice';
            document.getElementById('invoiceId').value = invoice.id;
            document.getElementById('clientName').value = invoice.client;
            document.getElementById('clientDetail').value = invoice.clientDetail || '';
            document.getElementById('leadName').value = invoice.lead || '';
            document.getElementById('leadEmail').value = invoice.leadEmail || '';
            document.getElementById('balance').value = invoice.balance;
            document.getElementById('invoiceLink').value = invoice.link || '';
            document.getElementById('extractionStatus').innerHTML = '';
            
            document.getElementById('invoiceModal').classList.add('active');
            updateLeadSuggestions();
            
            // Set dropdown to current lead if it exists
            const leadDropdown = document.getElementById('leadDropdown');
            if (invoice.lead) {
                leadDropdown.value = invoice.lead;
            } else {
                leadDropdown.value = '';
            }
        }

        // Close invoice modal
        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.remove('active');
            editingIndex = null;
        }

        // Handle lead selection from dropdown
        function handleLeadSelection(leadName) {
            if (leadName) {
                document.getElementById('leadName').value = leadName;
                // Auto-fill email if it's a predefined lead
                const leadEmail = getLeadEmail(leadName);
                if (leadEmail) {
                    document.getElementById('leadEmail').value = leadEmail;
                }
            }
        }

        // Update lead suggestions
        function updateLeadSuggestions() {
            const datalist = document.getElementById('leadSuggestions');
            const dropdown = document.getElementById('leadDropdown');
            
            // Get unique leads from existing invoices
            const existingLeads = getUniqueLeads();
            
            // Combine predefined leads with existing custom leads
            const predefinedLeadNames = predefinedLeads.map(l => l.name);
            const customLeads = existingLeads.filter(lead => !predefinedLeadNames.includes(lead));
            
            // All leads for datalist
            const allLeads = [...predefinedLeadNames, ...customLeads];
            
            // Update datalist
            datalist.innerHTML = allLeads.map(lead => `<option value="${lead}">`).join('');
            
            // Update dropdown - start fresh
            dropdown.innerHTML = '<option value="">-- Select a lead --</option>';
            
            // Add predefined leads section
            if (predefinedLeads.length > 0) {
                const predefinedHeader = document.createElement('option');
                predefinedHeader.disabled = true;
                predefinedHeader.textContent = '‚îÄ‚îÄ‚îÄ Founders Law Team ‚îÄ‚îÄ‚îÄ';
                predefinedHeader.style.fontWeight = 'bold';
                dropdown.appendChild(predefinedHeader);
                
                predefinedLeads.forEach(lead => {
                    const option = document.createElement('option');
                    option.value = lead.name;
                    option.textContent = `${lead.name} (${lead.email})`;
                    dropdown.appendChild(option);
                });
            }
            
            // Add custom leads section if any exist
            if (customLeads.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '‚îÄ‚îÄ‚îÄ Custom Leads ‚îÄ‚îÄ‚îÄ';
                separator.style.fontWeight = 'bold';
                dropdown.appendChild(separator);
                
                customLeads.forEach(lead => {
                    const option = document.createElement('option');
                    option.value = lead;
                    option.textContent = lead;
                    dropdown.appendChild(option);
                });
            }
            
            // Add "type new" option
            const finalSeparator = document.createElement('option');
            finalSeparator.disabled = true;
            finalSeparator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
            dropdown.appendChild(finalSeparator);
            
            const newOption = document.createElement('option');
            newOption.value = '';
            newOption.textContent = '‚úèÔ∏è Type new lead name below';
            dropdown.appendChild(newOption);
        }

        // Save invoice
        function saveInvoice(event) {
            event.preventDefault();
            
            const invoice = {
                id: document.getElementById('invoiceId').value,
                client: document.getElementById('clientName').value,
                clientDetail: document.getElementById('clientDetail').value,
                lead: document.getElementById('leadName').value,
                leadEmail: document.getElementById('leadEmail').value,
                balance: parseFloat(document.getElementById('balance').value),
                link: document.getElementById('invoiceLink').value
            };
            
            if (editingIndex !== null) {
                invoices[editingIndex] = invoice;
            } else {
                invoices.push(invoice);
            }
            
            saveInvoices();
            updateLeadFilter();
            updateShareLinks();
            updateUnassignedCount();
            renderInvoices();
            closeInvoiceModal();
        }

        // Delete invoice
        function deleteInvoice(index) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                invoices.splice(index, 1);
                saveInvoices();
                updateLeadFilter();
                updateShareLinks();
                updateUnassignedCount();
                renderInvoices();
            }
        }

        // ===== HARVEST API FUNCTIONS =====

        // Open Harvest settings modal
        async function openHarvestSettingsModal() {
            const settings = await loadHarvestSettings();
            document.getElementById('harvestAccountId').value = settings.accountId;
            document.getElementById('harvestAccessToken').value = settings.accessToken;
            document.getElementById('harvestInvoiceState').value = settings.invoiceState;
            document.getElementById('productionUrl').value = settings.productionUrl;
            document.getElementById('adminPasswordSetting').value = settings.adminPassword;
            document.getElementById('harvestStatusMessage').innerHTML = '';
            document.getElementById('harvestSettingsModal').classList.add('active');
        }

        // Close Harvest settings modal
        function closeHarvestSettingsModal() {
            document.getElementById('harvestSettingsModal').classList.remove('active');
        }

        // Save and test Harvest settings
        async function saveHarvestSettings() {
            const accountId = document.getElementById('harvestAccountId').value.trim();
            const accessToken = document.getElementById('harvestAccessToken').value.trim();
            const invoiceState = document.getElementById('harvestInvoiceState').value;
            const productionUrl = document.getElementById('productionUrl').value.trim();
            const adminPassword = document.getElementById('adminPasswordSetting').value;
            const statusDiv = document.getElementById('harvestStatusMessage');

            if (!accountId || !accessToken) {
                statusDiv.innerHTML = '<div class="status-message status-error">Please enter both Account ID and Access Token</div>';
                return;
            }
            
            if (!productionUrl) {
                statusDiv.innerHTML = '<div class="status-message status-error">Please enter the Production URL for email links</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status-message status-loading">Testing connection to Harvest...</div>';

            try {
                // Test the API connection
                const response = await fetch('https://api.harvestapp.com/v2/users/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Harvest-Account-Id': accountId,
                        'User-Agent': 'Founders Law Invoice Approval (admin@founderslaw.com)'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Save settings to Google Sheets
                    await saveHarvestSetting('harvestAccountId', accountId);
                    await saveHarvestSetting('harvestAccessToken', accessToken);
                    await saveHarvestSetting('harvestInvoiceState', invoiceState);
                    await saveHarvestSetting('productionUrl', productionUrl);
                    await saveHarvestSetting('adminPassword', adminPassword);

                    statusDiv.innerHTML = `<div class="status-message status-success">‚úÖ Connected successfully!<br>Account: ${data.email || 'Connected'}</div>`;
                    
                    setTimeout(() => {
                        closeHarvestSettingsModal();
                    }, 2000);
                } else {
                    const error = await response.text();
                    statusDiv.innerHTML = `<div class="status-message status-error">‚ùå Connection failed: ${response.status} ${response.statusText}<br>Please check your credentials.</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-message status-error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Sync invoices from Harvest
        async function syncFromHarvest() {
            const settings = await loadHarvestSettings();

            if (!settings.accountId || !settings.accessToken) {
                alert('Please configure your Harvest API credentials first.\n\nClick "‚öôÔ∏è Harvest API" to set up.');
                openHarvestSettingsModal();
                return;
            }

            const stateLabel = settings.invoiceState === 'draft' ? 'DRAFT' : 
                              settings.invoiceState === 'open' ? 'OPEN' : 
                              settings.invoiceState === 'paid' ? 'PAID' : 'ALL';

            if (!confirm(`This will sync ${stateLabel} invoices from Harvest.\n\n‚Ä¢ New invoices will be imported\n‚Ä¢ Existing invoices will be updated with latest data\n‚Ä¢ Invoices no longer ${stateLabel.toLowerCase()} will be removed (they've been sent)\n\nContinue?`)) {
                return;
            }

            try {
                // Show loading state
                const syncBtn = document.getElementById('syncHarvestBtn');
                const originalText = syncBtn.textContent;
                syncBtn.textContent = '‚è≥ Syncing...';
                syncBtn.disabled = true;

                // Build API URL with filters
                let apiUrl = 'https://api.harvestapp.com/v2/invoices?per_page=100';
                if (settings.invoiceState) {
                    apiUrl += `&state=${settings.invoiceState}`;
                }

                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${settings.accessToken}`,
                        'Harvest-Account-Id': settings.accountId,
                        'User-Agent': 'Founders Law Invoice Approval (admin@founderslaw.com)'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Harvest API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const harvestInvoices = data.invoices || [];

                if (harvestInvoices.length === 0) {
                    alert(`No ${stateLabel} invoices found in Harvest.`);
                    syncBtn.textContent = originalText;
                    syncBtn.disabled = false;
                    return;
                }

                // Load current approval state
                const approvals = loadApprovalState();

                // Get list of invoice IDs from Harvest
                const harvestInvoiceIds = new Set(
                    harvestInvoices.map(hInv => hInv.number || `H-${hInv.id}`)
                );

                console.log('=== SYNC DEBUG ===');
                console.log('Harvest draft invoice IDs:', Array.from(harvestInvoiceIds));
                console.log('Current invoices:', invoices.map(inv => ({ id: inv.id, client: inv.client })));

                // Remove invoices that are no longer drafts in Harvest
                // Logic: If it's not a draft anymore, it's been sent - remove it
                let removedCount = 0;
                const removedInvoices = [];
                invoices = invoices.filter(inv => {
                    // Only keep if it's still in the Harvest draft list
                    if (harvestInvoiceIds.has(inv.id)) {
                        console.log(`Keeping ${inv.id} (${inv.client}) - still a draft in Harvest`);
                        return true;
                    }
                    // Remove if not in draft list (it's been sent)
                    console.log(`Removing ${inv.id} (${inv.client}) - no longer a draft (sent)`);
                    removedInvoices.push(inv.client);
                    removedCount++;
                    
                    // Note: Approval will be orphaned in sheet but that's OK
                    
                    return false;
                });

                console.log('Removed invoices:', removedInvoices);
                console.log('=== END SYNC DEBUG ===');

                // Map Harvest invoices to our format
                let importedCount = 0;
                let updatedCount = 0;

                harvestInvoices.forEach(hInv => {
                    // Create a unique ID from Harvest invoice number or ID
                    const invoiceId = hInv.number || `H-${hInv.id}`;
                    
                    // Check if invoice already exists
                    const existingIndex = invoices.findIndex(inv => inv.id === invoiceId);
                    
                    if (existingIndex !== -1) {
                        // Update existing invoice, but preserve lead assignment and email if already set
                        const existing = invoices[existingIndex];
                        
                        invoices[existingIndex] = {
                            id: invoiceId,
                            client: hInv.client?.name || 'Unknown Client',
                            clientDetail: hInv.subject || '',
                            lead: existing.lead || '', // Preserve existing lead
                            leadEmail: existing.leadEmail || '', // Preserve existing email
                            balance: parseFloat(hInv.amount) || 0,
                            link: `https://founderslaw.harvestapp.com/invoices/${hInv.id}`,
                            notes: existing.notes || '', // Preserve existing notes/feedback
                            noteActioned: existing.noteActioned || false // Preserve actioned status
                        };
                        
                        updatedCount++;
                        // Note: Approval status is preserved automatically in the approvals object
                    } else {
                        // Add new invoice
                        const newInvoice = {
                            id: invoiceId,
                            client: hInv.client?.name || 'Unknown Client',
                            clientDetail: hInv.subject || '',
                            lead: '', // Will need to be assigned manually
                            leadEmail: '',
                            balance: parseFloat(hInv.amount) || 0,
                            link: `https://founderslaw.harvestapp.com/invoices/${hInv.id}`,
                            notes: '', // No notes on new invoices
                            noteActioned: false
                        };

                        invoices.push(newInvoice);
                        importedCount++;
                    }
                });

                // Sort alphabetically by client name
                invoices.sort((a, b) => {
                    const clientA = (a.client || '').toLowerCase();
                    const clientB = (b.client || '').toLowerCase();
                    return clientA.localeCompare(clientB);
                });

                // Save and refresh
                saveInvoices();
                updateLeadFilter();
                updateShareLinks();
                updateUnassignedCount();
                renderInvoices();

                syncBtn.textContent = originalText;
                syncBtn.disabled = false;

                // Build message based on what happened
                let message = `‚úÖ Sync complete!\n\n`;
                if (importedCount > 0) {
                    message += `‚Ä¢ ${importedCount} new invoice${importedCount !== 1 ? 's' : ''} imported\n`;
                }
                if (updatedCount > 0) {
                    message += `‚Ä¢ ${updatedCount} existing invoice${updatedCount !== 1 ? 's' : ''} updated\n`;
                }
                if (removedCount > 0) {
                    message += `‚Ä¢ ${removedCount} invoice${removedCount !== 1 ? 's' : ''} removed (no longer drafts in Harvest):\n`;
                    removedInvoices.forEach(client => {
                        message += `  - ${client}\n`;
                    });
                }
                if (importedCount === 0 && updatedCount === 0 && removedCount === 0) {
                    message += `No changes - all invoices are up to date.`;
                } else if (importedCount > 0) {
                    message += `\nPlease assign account leads to new invoices.`;
                }

                alert(message);

            } catch (error) {
                console.error('Harvest sync error:', error);
                alert(`‚ùå Error syncing from Harvest:\n\n${error.message}\n\nPlease check your API credentials and try again.`);
                
                const syncBtn = document.getElementById('syncHarvestBtn');
                syncBtn.textContent = 'üîÑ Sync from Harvest';
                syncBtn.disabled = false;
            }
        }

        // ===== NOTES/FEEDBACK FUNCTIONS =====

        // Open notes modal
        function openNotesModal(invoiceId) {
            editingNotesInvoiceId = invoiceId;
            const invoice = invoices.find(inv => inv.id === invoiceId);
            
            if (!invoice) return;
            
            document.getElementById('notesModalTitle').textContent = invoice.notes ? 'üí¨ View/Edit Feedback' : 'üí¨ Add Feedback';
            document.getElementById('notesModalInvoiceInfo').textContent = `Invoice: ${invoice.id} - ${invoice.client}`;
            document.getElementById('invoiceNotes').value = invoice.notes || '';
            
            // Show/hide actioned status
            const actionedStatus = document.getElementById('notesActionedStatus');
            if (invoice.notes && invoice.noteActioned) {
                actionedStatus.style.display = 'block';
            } else {
                actionedStatus.style.display = 'none';
            }
            
            // Update toggle button
            const toggleBtn = document.getElementById('toggleActionedBtn');
            const clearBtn = document.getElementById('clearNotesBtn');
            
            if (invoice.notes && invoice.notes.trim() !== '') {
                // Show action buttons only if there are notes
                toggleBtn.style.display = 'inline-block';
                
                if (invoice.noteActioned) {
                    toggleBtn.textContent = 'Mark as Not Actioned';
                    toggleBtn.className = 'btn btn-secondary';
                } else {
                    toggleBtn.textContent = 'Mark as Actioned';
                    toggleBtn.className = 'btn btn-primary';
                }
                
                // Show clear button only in admin mode
                if (adminMode) {
                    clearBtn.style.display = 'inline-block';
                }
            } else {
                // No notes - hide action buttons
                toggleBtn.style.display = 'none';
                clearBtn.style.display = 'none';
            }
            
            document.getElementById('notesModal').classList.add('active');
        }

        // Close notes modal
        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('active');
            editingNotesInvoiceId = null;
        }

        // Save notes
        function saveNotes() {
            if (!editingNotesInvoiceId) return;
            
            const invoice = invoices.find(inv => inv.id === editingNotesInvoiceId);
            if (!invoice) return;
            
            const notes = document.getElementById('invoiceNotes').value.trim();
            const notesChanged = invoice.notes !== notes;
            
            invoice.notes = notes;
            
            // Reset actioned status if notes were changed
            if (notesChanged && notes) {
                invoice.noteActioned = false;
            }
            
            saveInvoices();
            renderInvoices();
            closeNotesModal();
        }

        // Toggle note actioned status
        function toggleNoteActioned() {
            if (!editingNotesInvoiceId) return;
            
            const invoice = invoices.find(inv => inv.id === editingNotesInvoiceId);
            if (!invoice || !invoice.notes) return;
            
            // Toggle the actioned status
            invoice.noteActioned = !invoice.noteActioned;
            
            saveInvoices();
            renderInvoices();
            closeNotesModal();
            
            if (invoice.noteActioned) {
                alert('‚úÖ Note marked as actioned!');
            }
        }

        // Clear notes
        function clearNotes() {
            if (!confirm('Are you sure you want to clear these notes? This will remove the note and its actioned status.')) return;
            
            if (!editingNotesInvoiceId) return;
            
            const invoice = invoices.find(inv => inv.id === editingNotesInvoiceId);
            if (!invoice) return;
            
            invoice.notes = '';
            invoice.noteActioned = false;
            
            saveInvoices();
            renderInvoices();
            closeNotesModal();
        }

        // Initialize
        (async function init() {
            try {
                // Show loading state
                document.getElementById('invoiceTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="border: none; text-align: center; padding: 40px;">
                            <div style="color: #6b7280; font-size: 14px;">
                                ‚è≥ Loading invoices from Google Sheets...
                            </div>
                        </td>
                    </tr>
                `;
                
                await initializeSampleData();
                updateLeadFilter();
                
                const urlParams = new URLSearchParams(window.location.search);
                const leadParam = urlParams.get('lead');
                if (leadParam) {
                    document.getElementById('leadFilter').value = leadParam;
                    document.getElementById('headerSubtitle').textContent = `Invoices for ${leadParam}`;
                }
                
                await renderInvoices();
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('invoiceTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="border: none; text-align: center; padding: 40px;">
                            <div style="color: #ef4444; font-size: 14px;">
                                ‚ùå Error loading data from Google Sheets. Please refresh the page.
                            </div>
                        </td>
                    </tr>
                `;
            }
        })();
    </script>
</body>
</html>
